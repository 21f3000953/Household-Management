{% extends 'layout.html' %}

{% block title %}Service Professional Dashboard - Urban Company{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1 class="mb-4">Welcome to Your Service Professional Dashboard</h1>

    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-3 text-center">
                    {% if professional.profile_photo %}
                        <img src="{{ url_for('static', filename='uploads/profile_photos/' + professional.profile_photo) }}"
                             class="img-fluid rounded-circle mb-3" style="width: 150px; height: 150px; object-fit: cover;"
                             alt="Profile Photo">
                    {% else %}
                        <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center mx-auto mb-3"
                             style="width: 150px; height: 150px; color: white; font-size: 3rem;">
                            {{ user.username[0].upper() }}
                        </div>
                    {% endif %}
                </div>
                <div class="col-md-9">
                    <h5 class="card-title">Your Profile</h5>
                    <p><strong>Name:</strong> {{ user.username }}</p>
                    <p><strong>Service:</strong> {{ professional.service.service_name }}</p>
                    <p><strong>Experience:</strong> {{ professional.experience }} years</p>
                    <p><strong>Average Rating:</strong> {{ "%.2f"|format(professional.average_rating) }} / 5.0</p>
                    {% if professional.verified %}
                        <p><span class="badge bg-success">Verified Professional</span></p>
                    {% else %}
                        <p><span class="badge bg-warning text-dark">Verification Pending</span></p>
                    {% endif %}
                    <a href="{{ url_for('edit_professional_experience') }}" class="btn btn-primary">Update Profile</a>
                </div>
            </div>
        </div>
    </div>

    <h2 class="mb-3">Pending Requests</h2>
    {% if pending_requests %}
        <div class="list-group mb-4">
            {% for request in pending_requests %}
                <div class="list-group-item">
                    <h5 class="mb-1">Request #{{ request.id }}</h5>
                    <p class="mb-1"><strong>Service:</strong> {{ request.service.service_name }}</p>
                    <p class="mb-1"><strong>Date/Time:</strong> {{ request.request_datetime.strftime('%Y-%m-%d %H:%M') }}</p>
                    <p class="mb-1"><strong>Location:</strong> {{ request.location }}</p>
                    <p class="mb-1"><strong>Remarks:</strong> {{ request.remarks or 'None' }}</p>
                    <div class="mt-2">
                        <form action="{{ url_for('accept_request', request_id=request.id) }}" method="POST" style="display: inline;">
                            <button type="submit" class="btn btn-success btn-sm" onclick="return confirm('Are you sure you want to accept this request?')">Accept</button>
                        </form>
                        <form action="{{ url_for('reject_request', request_id=request.id) }}" method="POST" style="display: inline;">
                            <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to reject this request?')">Reject</button>
                        </form>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p>No pending requests at the moment.</p>
    {% endif %}

    <h2 class="mb-3">Accepted Requests</h2>
    {% if accepted_requests %}
        <div class="list-group">
            {% for request in accepted_requests %}
                <div class="list-group-item">
                    <h5 class="mb-1">Request #{{ request.id }}</h5>
                    <p class="mb-1"><strong>Service:</strong> {{ request.service.service_name }}</p>
                    <p class="mb-1"><strong>Date/Time:</strong> {{ request.request_datetime.strftime('%Y-%m-%d %H:%M') }}</p>
                    <p class="mb-1"><strong>Location:</strong> {{ request.location }}</p>
                    <p class="mb-1"><strong>Remarks:</strong> {{ request.remarks or 'None' }}</p>
                    <div class="mt-2">
                        <a href="{{ url_for('complete_service', request_id=request.id) }}" class="btn btn-primary btn-sm">Mark as Completed</a>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p>No accepted requests at the moment.</p>
    {% endif %}
    <h2 class="mb-3">Completed Services</h2>
    {% if completed_services %}
        <div class="list-group mb-4">
            {% for service in completed_services %}
                <div class="list-group-item">
                    <h5 class="mb-1">Service #{{ service.id }}</h5>
                    <p class="mb-1"><strong>Service:</strong> {{ service.service.service_name }}</p>
                    <p class="mb-1"><strong>Date/Time:</strong> {{ service.request_datetime.strftime('%Y-%m-%d %H:%M') }}</p>
                    <p class="mb-1"><strong>Location:</strong> {{ service.location }}</p>
                    <p class="mb-1"><strong>Remarks:</strong> {{ service.remarks or 'None' }}</p>
                    <p class="mb-1"><strong>Completion Date:</strong> {{ service.completed_at.strftime('%Y-%m-%d %H:%M') if service.completed_at else 'Not recorded' }}</p>

                    {% if service.review and service.review.is_submitted %}
                        <div class="mt-3 p-3 bg-light rounded">
                            <h6 class="mb-2">Customer Review</h6>
                            <p class="mb-1">
                                <strong>Rating:</strong>
                                <span class="text-warning">
                                    {% for _ in range(service.review.rating) %}★{% endfor %}
                                    {% for _ in range(5 - service.review.rating) %}☆{% endfor %}
                                </span>
                                ({{ service.review.rating }}/5)
                            </p>
                            {% if service.review.comment %}
                                <p class="mb-1"><strong>Comment:</strong> {{ service.review.comment }}</p>
                            {% endif %}
                            <small class="text-muted">Reviewed on: {{ service.review.created_at.strftime('%Y-%m-%d') }}</small>
                        </div>
                    {% else %}
                        <p class="mb-1 text-muted"><em>Customer review pending</em></p>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p>No completed services yet.</p>
    {% endif %}
</div>
{% endblock %}